---
title: "create_lmer_fits"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{create_lmer_fits}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)

```

```{r setup}
library(boots.lmer)
```

This vignette shows how to generate LMER fits using the `boots.lmer::boots.lmer` function from the bootstrap samples generated with the `boots.lmer::boots.samples` function. Please refer to 'create_bootstrap_samples' vignette to see detailed description of how to use `boots.samples` function.

# Generate example data and bootstrap samples

Here's an example data and its 4 bootstrap samples.:
```{r}
set.seed(1020)
example.subject<-c("Sarah","John","Beth","Anna","Sarah","Sarah","Chris","Blake","John","Anna")
example.dat<-data.frame("Y"=rnorm(n=length(example.subject)),
                        "X1"=rpois(n=length(example.subject), lambda = 3),
                        "X2"=rnorm(n=length(example.subject)),
                        "X3"=rbeta(n=length(example.subject), shape1 = 3, shape2 = 0.5)+rnorm(length(example.subject), mean=6),
                        "subjects"=example.subject) #generate example data


output<-boots.samples(dat=example.dat,sub.id ="subjects",B=4) #a list of 4 bootstrap samples 

```


<br>

# Fit LMER to all bootstrap samples

With the bootstrap samples, we fit the LMER.
```{r}
lmer.out<-boots.lmer(y="Y", X=c("X1","X2","X3"), boots.samples.list = output)

lmer.out
```



<br>

# Make an inference with LMER output

We will generate 5,000 bootstrap samples and fit additive LMER model with random effects. And then we will generate a histogram of estimated effects of `X1`, `X2`, and `X3`.

```{r cache=TRUE}
set.seed(1204)
output<-boots.samples(dat=example.dat,sub.id ="subjects",B=5000)

```


Fit LMER: 

```{r cache=TRUE}
lmer.out<-boots.lmer(y="Y", X=c("X1","X2","X3"), boots.samples.list = output)
```


From each fit, we will extract estimated effects and show its histogram. Note that if the data set only contained unique observation (no repeated measure of the same subject), then simply, linear regression is fitted instead of LMER. 

```{r}
coef.out<-
lapply(lmer.out,function(fit){
  if(class(fit)=="lm"){ #If linear model was fit, use below function
    coef(fit)
  }else{ #IF 
    lme4::fixef(fit)
  }
})
```
Note that when fitting LMER, there might be lack of ranks in fixed effects matrix, so the `lme4::lmer` function can drop one variable. We will show an example:

```{r}

#extract coefficient estimate for X3
this.X3<-
lapply(coef.out,function(x){
  x["X3"]
})
est.X3<-unlist(this.X3)

#Here the number of NA's
sum(is.na(est.X3))

#index of all whose estimated effect of X3 is NA
which(is.na(est.X3)) 
```

Let's take a look at 27th fit

```{r}
lmer.out[[27]]
```

Under the fit warnings, it says "fixed-effect model matrix is rank deficient so dropping 1 column". Now we plot histogram of the estimated effects of `X3`.

```{r}
hist(est.X3)
```

